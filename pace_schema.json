{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.org/pace_schema.json",
  "title": "PACE/PANCE Campaign Schema",
  "type": "object",
  "additionalProperties": false,
  "required": ["schema_version", "campaign"],
  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "description": "SemVer for the schema."
    },
    "campaign": {
      "$ref": "#/$defs/Campaign"
    }
  },

  "$defs": {
    "IdSlug": {
      "type": "string",
      "pattern": "^[a-z0-9][a-z0-9-_]{1,63}$",
      "description": "URL-safe ID (lowercase, 2â€“64 chars)."
    },
    "IsoDateTime": {
      "type": "string",
      "format": "date-time"
    },
    "Sha256": {
      "type": "string",
      "pattern": "^[A-Fa-f0-9]{64}$"
    },
    "Uri": {
      "type": "string",
      "format": "uri"
    },
    "MeasuredValue": {
      "type": "object",
      "additionalProperties": false,
      "required": ["value"],
      "properties": {
        "value": { "type": "number" },
        "error": { "type": "number" },
        "method": {
          "type": "string",
          "enum": ["plaque", "qPCR", "spectro", "other"]
        },
        "notes": { "type": "string" }
      }
    },
    "Inducer": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "concentration_mM"],
      "properties": {
        "name": { "type": "string" },
        "concentration_mM": { "type": "number" }
      }
    },
    "Antibiotic": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "concentration_ug_per_ml"],
      "properties": {
        "name": { "type": "string" },
        "concentration_ug_per_ml": { "type": "number" }
      }
    },
    "FileRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["uri", "sha256", "size_bytes"],
      "properties": {
        "uri": { "$ref": "#/$defs/Uri" },
        "sha256": { "$ref": "#/$defs/Sha256" },
        "size_bytes": { "type": "integer", "minimum": 0 },
        "description": { "type": "string" }
      }
    },
    "FastqFile": {
      "type": "object",
      "additionalProperties": false,
      "required": ["read", "uri", "sha256", "size_bytes"],
      "properties": {
        "read": { "type": "string", "enum": ["R1", "R2", "I1", "I2"] },
        "uri": { "$ref": "#/$defs/Uri" },
        "sha256": { "$ref": "#/$defs/Sha256" },
        "size_bytes": { "type": "integer", "minimum": 0 },
        "sample_sheet_id": { "type": "string" },
        "description": { "type": "string" }
      }
    },

    "StartingProtein": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "dna_seq", "aa_seq"],
      "properties": {
        "name": { "type": "string" },
        "uniprot_id": { "type": "string" },
        "dna_seq": { "type": "string", "pattern": "^[ACGTNacgtn]+$" },
        "aa_seq": { "type": "string", "pattern": "^[ACDEFGHIKLMNPQRSTVWYXBZ\\*]+$" },
        "features": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["label", "start", "end"],
            "properties": {
              "label": { "type": "string" },
              "start": { "type": "integer", "minimum": 1 },
              "end": { "type": "integer", "minimum": 1 }
            }
          }
        },
        "vector_context": { "type": "string" },
        "extra": { "type": "object" }
      }
    },

    "SelectionCircuit": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "type"],
      "properties": {
        "id": { "$ref": "#/$defs/IdSlug" },
        "type": {
          "type": "string",
          "enum": [
            "RNAP_promoter", "one_hybrid", "two_hybrid",
            "protease_split", "base_editing", "gVI", "other"
          ]
        },
        "ap_details": { "type": "string" },
        "cp_details": { "type": "string" },
        "reporter_gene": { "type": "string", "enum": ["gIII", "gVI", "other"] },
        "negative_selection": { "type": "string" },
        "stepping_stones": {
          "type": "array",
          "items": { "type": "string" }
        },
        "version": { "type": "string" },
        "extra": { "type": "object" }
      }
    },

    "HostSystem": {
      "type": "object",
      "additionalProperties": false,
      "required": ["strain"],
      "properties": {
        "strain": { "type": "string" },
        "genotype": { "type": "string" },
        "F_prime_status": { "type": "string" },
        "plasmids": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "AP": { "type": "string" },
            "CP": { "type": "string" },
            "MP": { "type": "string" },
            "DP": { "type": "string" }
          }
        },
        "resistances": {
          "type": "array",
          "items": { "type": "string" }
        },
        "extra": { "type": "object" }
      }
    },

    "Conditions": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode"],
      "properties": {
        "mode": { "type": "string", "enum": ["PACE", "PANCE"] },
        "volume_ml": { "type": "number", "minimum": 0 },
        "dilution_rate_vol_per_hr": { "type": "number", "minimum": 0 },
        "passage_fraction": { "type": "number", "minimum": 0, "maximum": 1 },
        "temp_c": { "type": "number" },
        "media": { "type": "string" },
        "antibiotics": {
          "type": "array",
          "items": { "$ref": "#/$defs/Antibiotic" }
        },
        "inducers": {
          "type": "array",
          "items": { "$ref": "#/$defs/Inducer" }
        },
        "flow_circuit": { "type": "string" },
        "selection_circuit_id": { "$ref": "#/$defs/IdSlug" },
        "extra": { "type": "object" }
      },
      "allOf": [
        {
          "if": { "properties": { "mode": { "const": "PACE" } } },
          "then": {
            "required": ["dilution_rate_vol_per_hr"],
            "not": { "required": ["passage_fraction"] }
          }
        },
        {
          "if": { "properties": { "mode": { "const": "PANCE" } } },
          "then": {
            "required": ["passage_fraction"],
            "not": { "required": ["dilution_rate_vol_per_hr"] }
          }
        }
      ]
    },

    "Measurements": {
      "type": "object",
      "additionalProperties": false,
      "required": ["phage_titer_pfu_per_ml"],
      "properties": {
        "phage_titer_pfu_per_ml": { "$ref": "#/$defs/MeasuredValue" },
        "od600": { "$ref": "#/$defs/MeasuredValue" },
        "cell_density": { "$ref": "#/$defs/MeasuredValue" },
        "viability": { "$ref": "#/$defs/MeasuredValue" },
        "biofilm_flag": { "type": "boolean" },
        "notes": { "type": "string" },
        "extra": { "type": "object" }
      }
    },

    "SequencingRun": {
      "type": "object",
      "additionalProperties": false,
      "required": ["run_id", "platform", "fastq"],
      "properties": {
        "run_id": { "$ref": "#/$defs/IdSlug" },
        "platform": { "type": "string" },
        "flowcell": { "type": "string" },
        "lanes": {
          "type": "array",
          "items": { "type": "string" }
        },
        "fastq": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/FastqFile" }
        },
        "demux": { "type": "string" },
        "qc": { "type": "string" },
        "notes": { "type": "string" },
        "extra": { "type": "object" }
      }
    },

    "LibraryPrep": {
      "type": "object",
      "additionalProperties": false,
      "required": ["library_id", "protocol"],
      "properties": {
        "library_id": { "$ref": "#/$defs/IdSlug" },
        "protocol": { "type": "string" },
        "amplicon_targets": { "type": "string" },
        "enzymes_kits": { "type": "string" },
        "cycles": { "type": "integer", "minimum": 0 },
        "indexing": { "type": "string" },
        "fragment_size_dist": { "type": "string" },
        "qc": { "type": "string" },
        "sequencing_runs": {
          "type": "array",
          "items": { "$ref": "#/$defs/SequencingRun" }
        },
        "extra": { "type": "object" }
      }
    },

    "Sample": {
      "type": "object",
      "additionalProperties": false,
      "required": ["sample_id", "sample_type"],
      "properties": {
        "sample_id": { "$ref": "#/$defs/IdSlug" },
        "sample_type": {
          "type": "string",
          "enum": ["phage_supernatant", "cells", "DNA", "RNA"]
        },
        "aliquots": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["label"],
            "properties": {
              "label": { "type": "string" },
              "storage": { "type": "string" },
              "location": { "type": "string" }
            }
          }
        },
        "library_preps": {
          "type": "array",
          "items": { "$ref": "#/$defs/LibraryPrep" }
        },
        "extra": { "type": "object" }
      }
    },

    "Lagoon": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "lagoon_id", "condition_label", "mutagenesis_on",
        "conditions", "measurements", "samples"
      ],
      "properties": {
        "lagoon_id": { "$ref": "#/$defs/IdSlug" },
        "condition_label": { "type": "string" },
        "mutagenesis_on": { "type": "boolean" },
        "conditions": { "$ref": "#/$defs/Conditions" },
        "measurements": { "$ref": "#/$defs/Measurements" },
        "samples": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Sample" }
        },
        "notes": { "type": "string" },
        "extra": { "type": "object" }
      },
      "allOf": [
        {
          "if": {
            "properties": { "mutagenesis_on": { "const": true } }
          },
          "then": {
            "properties": {
              "conditions": {
                "required": ["inducers"],
                "properties": {
                  "inducers": { "minItems": 1 }
                }
              }
            }
          }
        }
      ]
    },

    "Timepoint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["t", "timestamp", "lagoons"],
      "properties": {
        "t": { "type": "integer", "minimum": 0 },
        "timestamp": { "$ref": "#/$defs/IsoDateTime" },
        "global_events": {
          "type": "array",
          "items": { "type": "string" }
        },
        "lagoons": {
          "type": "object",
          "additionalProperties": false,
          "patternProperties": {
            "^[a-z0-9][a-z0-9-_]{1,63}$": { "$ref": "#/$defs/Lagoon" }
          }
        },
        "extra": { "type": "object" }
      }
    },

    "Arm": {
      "type": "object",
      "additionalProperties": false,
      "required": ["arm_id", "timepoints"],
      "properties": {
        "arm_id": { "$ref": "#/$defs/IdSlug" },
        "label": { "type": "string" },
        "description": { "type": "string" },
        "initial_sp_stock_id": { "type": "string" },
        "status": { "type": "string", "enum": ["active", "terminated"] },
        "termination_reason": { "type": "string" },
        "timepoints": {
          "type": "array",
          "items": { "$ref": "#/$defs/Timepoint" }
        },
        "extra": { "type": "object" }
      }
    },

    "Segment": {
      "type": "object",
      "additionalProperties": false,
      "required": ["segment_id", "mode", "applied_to_arms", "start_time"],
      "properties": {
        "segment_id": { "$ref": "#/$defs/IdSlug" },
        "mode": { "type": "string", "enum": ["PACE", "PANCE"] },
        "applied_to_arms": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/IdSlug" }
        },
        "start_time": { "$ref": "#/$defs/IsoDateTime" },
        "end_time": { "$ref": "#/$defs/IsoDateTime" },
        "selection_design": {
          "type": "object",
          "additionalProperties": false,
          "required": ["selection_circuit_id"],
          "properties": {
            "selection_circuit_id": { "$ref": "#/$defs/IdSlug" },
            "stepping_stones": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        },
        "default_conditions": { "$ref": "#/$defs/Conditions" },
        "extra": { "type": "object" }
      }
    },

    "AnalysisOutputs": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "alignments": {
          "type": "array",
          "items": { "$ref": "#/$defs/FileRef" }
        },
        "variant_tables": {
          "type": "array",
          "items": { "$ref": "#/$defs/FileRef" }
        },
        "consensus_sequences": {
          "type": "array",
          "items": { "$ref": "#/$defs/FileRef" }
        },
        "selection_scores": {
          "type": "array",
          "items": { "$ref": "#/$defs/FileRef" }
        },
        "extra": { "type": "object" }
      }
    },

    "Analysis": {
      "type": "object",
      "additionalProperties": false,
      "required": ["analysis_id", "pipeline_id", "inputs"],
      "properties": {
        "analysis_id": { "$ref": "#/$defs/IdSlug" },
        "pipeline_id": { "type": "string" },
        "code_hash": { "type": "string", "pattern": "^[a-f0-9]{7,64}$" },
        "env": { "type": "string" },
        "ref_seq_id": { "type": "string" },
        "params": { "type": "object" },
        "inputs": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" }
        },
        "outputs": { "$ref": "#/$defs/AnalysisOutputs" },
        "provenance": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "who": { "type": "string" },
            "when": { "$ref": "#/$defs/IsoDateTime" }
          }
        },
        "notes": { "type": "string" },
        "extra": { "type": "object" }
      }
    },

    "Campaign": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "campaign_id", "title", "created_at",
        "starting_protein", "host_system", "arms", "segments"
      ],
      "properties": {
        "campaign_id": { "$ref": "#/$defs/IdSlug" },
        "title": { "type": "string" },
        "created_at": { "$ref": "#/$defs/IsoDateTime" },
        "created_by": { "type": "string" },
        "starting_protein": { "$ref": "#/$defs/StartingProtein" },
        "host_system": { "$ref": "#/$defs/HostSystem" },
        "arms": {
          "type": "object",
          "additionalProperties": false,
          "minProperties": 1,
          "patternProperties": {
            "^[a-z0-9][a-z0-9-_]{1,63}$": { "$ref": "#/$defs/Arm" }
          }
        },
        "segments": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Segment" }
        },
        "selection_circuits": {
          "type": "object",
          "additionalProperties": false,
          "patternProperties": {
            "^[a-z0-9][a-z0-9-_]{1,63}$": { "$ref": "#/$defs/SelectionCircuit" }
          }
        },
        "analyses": {
          "type": "array",
          "items": { "$ref": "#/$defs/Analysis" }
        },
        "attachments": {
          "type": "array",
          "items": { "$ref": "#/$defs/FileRef" }
        },
        "ontologies": {
          "type": "object",
          "description": "Controlled term lists; not strictly enforced by schema so you can evolve vocabularies.",
          "additionalProperties": {
            "type": "array",
            "items": { "type": "string" }
          }
        },
        "notes": { "type": "string" },
        "extra": { "type": "object" }
      }
    }
  }
}

